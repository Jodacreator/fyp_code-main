{% extends "global/Page.html" %}
{% block content %}

<h3>Round {{ player.round_number }}: Decision</h3>

<div class="row">
  <div class="col-md-8">

    <p>
      Endowment: <b>{{ endowment }}</b>.
      Choose how much to contribute (between <b>{{ min_contrib }}</b> and <b>{{ max_contrib }}</b>),
      then report your belief.
    </p>

    <!-- Neutral structure reminder (no jargon) -->
    <div class="alert alert-secondary" style="margin: 10px 0;">
      <b>Reminder:</b>
      {% if network_type == 'hub' %}
        One <b>central player</b> is connected to all other players (fixed for all rounds).
      {% else %}
        Each player is connected to two other players (fixed for all rounds).
      {% endif %}
    </div>

    <!-- Timer -->
    <div id="timer_box" class="alert alert-info" style="margin: 10px 0;">
      <b>Time remaining:</b> <span id="time_left">60</span> seconds
    </div>

    <!-- Contribution -->
    {{ formfield 'contribution' }}

    <hr>

    <!-- Belief slider -->
    <label for="belief_slider"><b>Belief report (0–100)</b></label>
    <div class="text-muted" style="margin-bottom: 6px;">
      0 = certain the state is LOW, 100 = certain the state is HIGH.
      (This does <b>not</b> affect earnings and is <b>not</b> shown to other players.)
    </div>

    <input
      type="range"
      id="belief_slider"
      name="belief"
      min="0"
      max="100"
      value="{{ belief_value }}"
      class="form-range"
      oninput="document.getElementById('belief_value').textContent = this.value;"
      style="width: 100%;"
    >
    <div style="margin-top: 6px;">
      Current value: <b><span id="belief_value">{{ belief_value }}</span></b>
    </div>

    <!-- ✅ Current Round Signals (Pill Badges) -->
    <div style="margin-top: 15px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa;">
      <div style="font-weight: 600; margin-bottom: 8px;">
        Signals This Round (Round {{ player.round_number }})
      </div>

      {% if current_round_signals %}
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          {% for item in current_round_signals %}

            {% if item.signal == "HIGH" %}
              <span style="
                padding: 6px 12px;
                border-radius: 999px;
                background-color: #d4edda;
                color: #155724;
                font-weight: 600;
                font-size: 14px;">
                {% if 'Hub' in item.source %}
                  Central player
                {% else %}
                  {{ item.source }}
                {% endif %}: HIGH
              </span>
            {% else %}
              <span style="
                padding: 6px 12px;
                border-radius: 999px;
                background-color: #f8d7da;
                color: #721c24;
                font-weight: 600;
                font-size: 14px;">
                {% if 'Hub' in item.source %}
                  Central player
                {% else %}
                  {{ item.source }}
                {% endif %}: LOW
              </span>
            {% endif %}

          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">No signals available.</div>
      {% endif %}
    </div>

  </div>

  <!-- Right panel: diagram + histories -->
  <div class="col-md-4">

    <!-- Interaction structure diagram -->
    <div style="position: sticky; top: 12px; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff; margin-bottom: 10px;">
      <b>Interaction structure</b>
      <div class="text-muted" style="font-size: 0.9em; margin-bottom: 6px;">
        Fixed for all rounds
      </div>

      <div style="width: 100%; overflow-x: auto;">
        <svg id="netSvgDecide" width="360" height="200" viewBox="0 0 520 240"></svg>
      </div>
    </div>

    <!-- Signals you saw (history) -->
    <div style="position: sticky; top: 260px; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff; margin-bottom: 10px;">
      <b>Signals you have seen</b>
      <div class="text-muted" style="font-size: 0.9em;">Rounds 1–{{ player.round_number }}</div>
      <hr style="margin: 8px 0;">

      {% for h in signals_history %}
        <details style="margin-bottom: 6px;">
          <summary>Round {{ h.round }}</summary>
          <ul style="margin: 6px 0 0 18px; padding: 0;">
            {% for item in h.observed %}
              <li>
                <b>
                  {% if 'Hub' in item.source %}
                    Central player
                  {% else %}
                    {{ item.source }}
                  {% endif %}
                </b>: {{ item.signal }}
              </li>
            {% endfor %}
          </ul>
        </details>
      {% endfor %}
    </div>

    <!-- Group contribution history -->
    <div style="position: sticky; top: 520px; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff;">
      <b>Group contributions so far</b>
      <div class="text-muted" style="font-size: 0.9em;">Completed rounds</div>
      <hr style="margin: 8px 0;">

      {% if contrib_history_all and contrib_history_all|length > 0 %}
        {% for block in contrib_history_all %}
          <details style="margin-bottom: 6px;">
            <summary>Round {{ block.round }}</summary>

            <table class="table table-sm" style="margin-top: 6px;">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Contribution</th>
                </tr>
              </thead>
              <tbody>
                {% for row in block.rows %}
                  <tr>
                    <td>
                      {% if row.is_you %}
                        <b>Player {{ row.pid }} (You)</b>
                      {% else %}
                        Player {{ row.pid }}
                      {% endif %}
                    </td>
                    <td>{{ row.contribution }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </details>
        {% endfor %}
      {% else %}
        <div class="text-muted">No completed rounds yet.</div>
      {% endif %}
    </div>

  </div>
</div>

<button class="btn btn-primary">Continue</button>

<script>
  // simple 60s countdown display (oTree timeout handled server-side)
  (function () {
    const el = document.getElementById('time_left');
    if (!el) return;

    let t = parseInt(el.textContent, 10);
    if (!Number.isFinite(t)) t = 60;

    const timer = setInterval(() => {
      t -= 1;
      if (t <= 0) {
        el.textContent = '0';
        clearInterval(timer);
        return;
      }
      el.textContent = String(t);
    }, 1000);
  })();
</script>

<script>
(function () {
    const networkType = "{{ network_type }}";
    const n = parseInt("{{ n }}", 10) || 8;
    const rawCentralId = parseInt("{{ hub_id }}", 10) || 0;
    const youId = parseInt("{{ pid }}", 10) || 0;

    const centralId = (Number.isFinite(rawCentralId) && rawCentralId >= 1) ? rawCentralId : 1;

    const svg = document.getElementById('netSvgDecide');
    if (!svg) return;

    const NS = 'http://www.w3.org/2000/svg';
    const cx = 260, cy = 120;
    const R = 95;

    function el(name, attrs) {
        const e = document.createElementNS(NS, name);
        for (const k in attrs) e.setAttribute(k, attrs[k]);
        return e;
    }

    function addText(x, y, txt, opts = {}) {
        const t = el('text', Object.assign({
            x, y,
            'text-anchor': 'middle',
            'dominant-baseline': 'middle',
            'font-size': '14'
        }, opts));
        t.textContent = txt;
        svg.appendChild(t);
    }

    function addNode(x, y, id, isCentral, isYou) {
        const fill = isCentral ? '#ffe9cc' : '#eaf2ff';
        const stroke = isYou ? '#111' : '#4a86e8';
        const strokeW = isYou ? '3' : '2';

        svg.appendChild(el('circle', {
            cx: x, cy: y, r: 20,
            fill: fill,
            stroke: stroke,
            'stroke-width': strokeW
        }));

        addText(x, y, String(id), { 'font-weight': '700' });

        if (isCentral)
            addText(x, y + 28, 'Central Player', { 'font-size': '12', fill: '#aa6600' });

        if (isYou)
            addText(x, y - 28, 'You', { 'font-size': '12', fill: '#111' });
    }

    function posRingById(id) {
        const angle = (-Math.PI / 2) + (2 * Math.PI) * ((id - 1) / n);
        return { x: cx + R * Math.cos(angle), y: cy + R * Math.sin(angle) };
    }

    function posOuterByIndex(idx, outerCount) {
        const angle = (-Math.PI / 2) + (2 * Math.PI) * (idx / outerCount);
        return { x: cx + R * Math.cos(angle), y: cy + R * Math.sin(angle) };
    }

    while (svg.firstChild) svg.removeChild(svg.firstChild);

    if (networkType === 'hub') {
        const outer = [];
        for (let i = 1; i <= n; i++) if (i !== centralId) outer.push(i);

        const outerCount = outer.length;

        // Lines first
        outer.forEach((id, idx) => {
            const p = posOuterByIndex(idx, outerCount);
            svg.appendChild(el('line', {
                x1: cx, y1: cy,
                x2: p.x, y2: p.y,
                stroke: '#999',
                'stroke-width': '2'
            }));
        });

        // Outer nodes
        outer.forEach((id, idx) => {
            const p = posOuterByIndex(idx, outerCount);
            addNode(p.x, p.y, id, false, id === youId);
        });

        // Central node last
        addNode(cx, cy, centralId, true, centralId === youId);

    } else {
        const positions = {};
        for (let i = 1; i <= n; i++) positions[i] = posRingById(i);

        for (let i = 1; i <= n; i++) {
            const j = (i === n) ? 1 : (i + 1);
            const a = positions[i], b = positions[j];
            svg.appendChild(el('line', {
                x1: a.x, y1: a.y,
                x2: b.x, y2: b.y,
                stroke: '#999',
                'stroke-width': '2'
            }));
        }

        for (let i = 1; i <= n; i++) {
            const p = positions[i];
            addNode(p.x, p.y, i, false, i === youId);
        }
    }
})();
</script>

{% endblock %}