{% extends "global/Page.html" %}
{% block content %}

<h3>Round {{ player.round_number }}: Decision</h3>

<div class="row">
  <div class="col-md-8">

    <p>
      Endowment: <b>{{ endowment }}</b>.
      Choose how much to contribute (between <b>{{ min_contrib }}</b> and <b>{{ max_contrib }}</b>),
      then report your belief.
    </p>

    <!-- Neutral structure reminder (no jargon) -->
    <div class="alert alert-secondary" style="margin: 10px 0;">
      <b>Reminder:</b>
      {% if network_type == 'hub' %}
        One <b>central player</b> is connected to all other players (fixed for all rounds).
      {% else %}
        Each player is connected to two other players (fixed for all rounds).
      {% endif %}
    </div>

    <!-- Timer -->
    <div id="timer_box" class="alert alert-info" style="margin: 10px 0;">
      <b>Time remaining:</b> <span id="time_left">60</span> seconds
    </div>

    <!-- Contribution -->
    {{ formfield 'contribution' }}

    <hr>

    <!-- Belief slider -->
    <label for="belief_slider"><b>Belief report (0–100)</b></label>
    <div class="text-muted" style="margin-bottom: 6px;">
      0 = certain the state is LOW, 100 = certain the state is HIGH.
      (This does <b>not</b> affect earnings and is <b>not</b> shown to other players.)
    </div>

    <input
      type="range"
      id="belief_slider"
      name="belief"
      min="0"
      max="100"
      value="{{ belief_value }}"
      class="form-range"
      oninput="document.getElementById('belief_value').textContent = this.value;"
      style="width: 100%;"
    >
    <div style="margin-top: 6px;">
      Current value: <b><span id="belief_value">{{ belief_value }}</span></b>
    </div>

  </div>

  <!-- Right panel: histories -->
  <div class="col-md-4">

    <!-- Signals you saw (history) -->
    <div style="position: sticky; top: 12px; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff; margin-bottom: 10px;">
      <b>Signals you have seen</b>
      <div class="text-muted" style="font-size: 0.9em;">Rounds 1–{{ player.round_number }}</div>
      <hr style="margin: 8px 0;">

      {% for h in signals_history %}
        <details style="margin-bottom: 6px;">
          <summary>Round {{ h.round }}</summary>
          <ul style="margin: 6px 0 0 18px; padding: 0;">
            {% for item in h.observed %}
              {# Optional: rename any remaining sources if they include "Hub" #}
              <li>
                <b>
                  {% if 'Hub' in item.source %}
                    Central player
                  {% else %}
                    {{ item.source }}
                  {% endif %}
                </b>: {{ item.signal }}
              </li>
            {% endfor %}
          </ul>
        </details>
      {% endfor %}
    </div>

    <!-- Group contribution history -->
    <div style="position: sticky; top: 360px; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff;">
      <b>Group contributions so far</b>
      <div class="text-muted" style="font-size: 0.9em;">Completed rounds</div>
      <hr style="margin: 8px 0;">

      {% if contrib_history_all and contrib_history_all|length > 0 %}
        {% for block in contrib_history_all %}
          <details style="margin-bottom: 6px;">
            <summary>Round {{ block.round }}</summary>

            <table class="table table-sm" style="margin-top: 6px;">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Contribution</th>
                </tr>
              </thead>
              <tbody>
                {% for row in block.rows %}
                  <tr>
                    <td>
                      {% if row.is_you %}
                        <b>Player {{ row.pid }} (You)</b>
                      {% else %}
                        Player {{ row.pid }}
                      {% endif %}
                    </td>
                    <td>{{ row.contribution }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </details>
        {% endfor %}
      {% else %}
        <div class="text-muted">No completed rounds yet.</div>
      {% endif %}
    </div>

  </div>
</div>

<button class="btn btn-primary">Continue</button>

<script>
  // simple 60s countdown display (oTree timeout handled server-side)
  (function () {
    const el = document.getElementById('time_left');
    if (!el) return;

    let t = parseInt(el.textContent, 10);
    if (!Number.isFinite(t)) t = 60;

    const timer = setInterval(() => {
      t -= 1;
      if (t <= 0) {
        el.textContent = '0';
        clearInterval(timer);
        return;
      }
      el.textContent = String(t);
    }, 1000);
  })();
</script>

{% endblock %}