{% extends "global/Page.html" %}
{% block content %}

<h3>Round {{ player.round_number }}: Signals</h3>

<p>
  <b>Network structure:</b>
  {% if network_type == 'hub' %}
    Hub-and-Spoke Network
  {% else %}
    Ring Network
  {% endif %}
</p>

<style>
  .net-wrap {
    width: 420px;
    max-width: 100%;
    height: 300px;
    position: relative;
    border: 1px solid #e5e5e5;
    border-radius: 10px;
    background: #fff;
    overflow: hidden;
  }

  /* Put lines behind nodes */
  .line {
    position: absolute;
    height: 2px;
    background: #999;
    transform-origin: 0 0;
    z-index: 1;
    opacity: 0.85;
  }

  .node {
    width: 58px;
    height: 58px;
    border-radius: 999px;
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid #2b6cb0;
    background: #eaf3ff;
    color: #1a365d;
    z-index: 5; /* above lines */
  }

  /* Hub even higher so it never gets crossed */
  .node.hub {
    background: #ffd9d9;
    border-color: #c53030;
    color: #742a2a;
    z-index: 10;
  }

  .node.you {
    box-shadow: 0 0 0 4px rgba(49, 130, 206, 0.35);
  }

  .node .role {
    position: absolute;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 600;
    color: #555;
    width: 90px;
    text-align: center;
    z-index: 11;
  }
</style>

<div style="margin: 12px 0;">
  <div class="net-wrap" id="net"></div>

  <div class="text-muted" style="margin-top: 6px;">
    Your node ID: <b>{{ pid }}</b>
    {% if network_type == 'hub' %}
      &nbsp;|&nbsp; Hub: <b>{{ hub_id }}</b>
    {% endif %}
  </div>
</div>

<script>
(function(){
  const networkType = "{{ network_type }}";
  const pid = Number("{{ pid }}");
  const hubId = Number("{{ hub_id }}");
  const n = 8;

  const wrap = document.getElementById("net");
  const W = wrap.clientWidth || 420;
  const H = wrap.clientHeight || 300;
  const cx = W/2, cy = H/2;

  function addNode(id, x, y, isHub=false){
    const d = document.createElement("div");
    d.className = "node" + (isHub ? " hub" : "") + (id===pid ? " you" : "");
    d.style.left = (x-29) + "px";
    d.style.top  = (y-29) + "px";
    d.textContent = String(id);

    const role = document.createElement("div");
    role.className = "role";
    role.textContent = isHub ? "Hub" : "Node";
    d.appendChild(role);

    wrap.appendChild(d);
  }

  function addLine(x1,y1,x2,y2){
    const dx = x2-x1, dy = y2-y1;
    const len = Math.sqrt(dx*dx+dy*dy);
    const ang = Math.atan2(dy,dx) * 180 / Math.PI;

    const l = document.createElement("div");
    l.className = "line";
    l.style.left = x1 + "px";
    l.style.top  = y1 + "px";
    l.style.width = len + "px";
    l.style.transform = "rotate(" + ang + "deg)";
    wrap.appendChild(l);
  }

  if(networkType === "hub"){
    // Draw spokes first (lines behind), then nodes
    const r = Math.min(W, H) * 0.32;
    const others = [];
    for(let i=1;i<=n;i++) if(i!==hubId) others.push(i);

    // Precompute spoke coords
    const spokeCoords = [];
    others.forEach((id, idx) => {
      const theta = (2*Math.PI*idx)/others.length - Math.PI/2;
      const x = cx + r*Math.cos(theta);
      const y = cy + r*Math.sin(theta);
      spokeCoords.push({id, x, y});
    });

    // Lines first
    spokeCoords.forEach(s => addLine(cx, cy, s.x, s.y));

    // Hub node last (always on top)
    addNode(hubId, cx, cy, true);

    // Spokes
    spokeCoords.forEach(s => addNode(s.id, s.x, s.y, false));

  } else {
    // Ring around
    const r = Math.min(W, H) * 0.35;
    const coords = {};
    for(let id=1; id<=n; id++){
      const theta = (2*Math.PI*(id-1))/n - Math.PI/2;
      coords[id] = [cx + r*Math.cos(theta), cy + r*Math.sin(theta)];
    }

    // Lines first
    for(let id=1; id<=n; id++){
      const next = (id===n) ? 1 : (id+1);
      addLine(coords[id][0], coords[id][1], coords[next][0], coords[next][1]);
    }

    // Nodes after (above lines)
    for(let id=1; id<=n; id++){
      addNode(id, coords[id][0], coords[id][1], false);
    }
  }
})();
</script>

<div style="margin: 12px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff;">
  <b>Your role:</b>
  {% if is_hub %}
    <span style="color:#007bff;">Central player (Hub)</span>
  {% else %}
    <span style="color:#555;">Connected player (Node)</span>
  {% endif %}
</div>

<p class="text-muted" style="margin-bottom: 10px;">
  The signals below are automatically shown to you by the network.
  No player can change, hide, or manipulate these signals.
</p>

<div class="row">
  <div class="col-md-8">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Source</th>
          <th>Signal</th>
        </tr>
      </thead>
      <tbody>
        {% for item in observed_signals %}
          <tr>
            <td>
              {% if item.source == 'You' %}
                <b>{{ item.source }}</b>
              {% else %}
                {{ item.source }}
              {% endif %}
            </td>
            <td><b>{{ item.signal }}</b></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="col-md-4">
    <div style="position: sticky; top: 12px; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px; background: #fff;">
      <b>Signals history</b>
      <div class="text-muted" style="font-size: 0.9em;">Rounds 1â€“{{ player.round_number }}</div>
      <hr style="margin: 8px 0;">
      {% for h in signals_history %}
        <details style="margin-bottom: 6px;">
          <summary>Round {{ h.round }}</summary>
          <ul style="margin: 6px 0 0 18px; padding: 0;">
            {% for item in h.observed %}
              <li><b>{{ item.source }}</b>: {{ item.signal }}</li>
            {% endfor %}
          </ul>
        </details>
      {% endfor %}
    </div>
  </div>
</div>

<button class="btn btn-primary">Continue</button>

{% endblock %}
